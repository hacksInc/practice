<?php
/**
 *  Adhoc/Point20140902.php
 *
 *  @author     {$author}
 *  @package    Pp
 *  @version    $Id$
 */

require_once 'Pp_CliActionClass.php';

/**
 *  adhoc_point20140902 Form implementation.
 *
 *  @author     {$author}
 *  @access     public
 *  @package    Pp
 */
class Pp_Cli_Form_AdhocPoint20140902 extends Pp_ActionForm
{
    /**
     *  @access private
     *  @var    array   form definition.
     */
    var $form = array(
    );
}

/**
 *  adhoc_point20140902 action implementation.
 *
 *  @author     {$author}
 *  @access     public
 *  @package    Pp
 */
class Pp_Cli_Action_AdhocPoint20140902 extends Pp_CliActionClass
{
    /**
     *  preprocess of adhoc_point20140902 Action.
     *
     *  @access public
     *  @return string    forward name(null: success.
     *                                false: in case you want to exit.)
     */
    function prepare()
    {
        return null;
    }

    /**
     *  adhoc_point20140902 action implementation.
     *
     *  @access public
     *  @return string  forward name.
     */
//    function perform()
//    {
////		$this->performDb();
////		$this->performMerge();
//		$this->performFormat();
//	}
//	
//	protected function performDb()
//	{
//		$admin_m =& $this->backend->getManager('Admin');
//		$shop_m =& $this->backend->getManager('AdminShop');
//		
//		$admin_m->offSessionQueryCache();
//		$admin_m->setSessionSqlBigSelectsOn(array('r'));
//
////TODO ユニット　環境変数を変えてこのアクションを2回呼ぶこと
//		
//		$user_id_list = array(
//810055849,
//810073254,
//810186527,
//810241146,
//810248016,
//810250244,
//810257354,
//810275928,
//810279657,
//810288298,
//810310342,
//810336503,
//810338085,
//810356363,
//810359780,
//810400179,
//810404157,
//810464667,
//810512952,
//810563393,
//810565348,
//810631741,
//810659647,
//810735901,
//810752633,
//810815811,
//810840857,
//810881586,
//810964706,
//810994936,
//811038325,
//811078237,
//811102479,
//811109777,
//811173954,
//811365551,
//811469065,
//811550752,
//811605028,
//811633972,
//811731397,
//811739574,
//811745877,
//811761793,
//811780946,
//811813943,
//811815023,
//811823662,
//811826132,
//811840006,
//811869703,
//811901008,
//811943181,
//811962341,
//811975184,
//812090934,
//812218429,
//812257067,
//812267997,
//812296924,
//812299525,
//812351613,
//812357351,
//812385872,
//812482921,
//812513158,
//812685818,
//812731123,
//812750095,
//812846294,
//812885566,
//812886696,
//812909342,
//812946887,
//812947672,
//812970070,
//812974055,
//813008752,
//813057000,
//813124007,
//813131313,
//813150354,
//813216527,
//813237180,
//813276858,
//813282658,
//813307134,
//813341023,
//813408202,
//813453997,
//813549408,
//813569124,
//813586082,
//813586247,
//813616368,
//813635008,
//813635332,
//813667611,
//813675462,
//813799949,
//813882957,
//813896279,
//813912146,
//814123513,
//814244651,
//814309958,
//814329184,
//814380218,
//814394745,
//814424342,
//814438967,
//814467175,
//814555286,
//814654366,
//814751056,
//814767169,
//814805732,
//814838013,
//814850554,
//814984711,
//815080418,
//815137993,
//815218905,
//815252349,
//815252887,
//815279016,
//815289529,
//815335759,
//815406378,
//815479507,
//815481654,
//815482768,
//815522061,
//815620848,
//815709564,
//815939766,
//815948457,
//815965086,
//816050822,
//816132734,
//816301773,
//816526624,
//816565967,
//816591323,
//816713494,
//816740416,
//816767732,
//816778760,
//816785904,
//816857319,
//816859047,
//817035370,
//817055183,
//817164935,
//817183060,
//817211596,
//817236112,
//817271947,
//817322639,
//817352809,
//817361096,
//817390909,
//817395820,
//817456322,
//817505373,
//817704141,
//817796256,
//817814286,
//817856712,
//817874899,
//817921253,
//817975091,
//818009615,
//818022549,
//818046796,
//818047402,
//818172343,
//818190941,
//818400672,
//818425039,
//818543394,
//818601203,
//818774045,
//818801590,
//818894794,
//818959529,
//819008748,
//819052515,
//819117073,
//819142113,
//819208969,
//819317757,
//819321698,
//819355513,
//819399974,
//819527562,
//819567457,
//819602543,
//819682558,
//819716367,
//819749872,
//819769846,
//819780775,
//819927865,
//819991301,
//820001419,
//820005202,
//820007566,
//820008266,
//820009930,
//820011057,
//820013018,
//820013445,
//820015791,
//820016729,
//820017081,
//820017891,
//820022210,
//820023202,
//820024279,
//820025184,
//820025224,
//820025439,
//820026236,
//820026532,
//820027352,
//820027598,
//820027737,
//820028405,
//820028814,
//820029535,
//820034324,
//820034455,
//820037134,
//820038158,
//820039203,
//820041874,
//820043283,
//820048851,
//820049101,
//820049496,
//820049528,
//820054081,
//820054908,
//820055263,
//820065771,
//820068620,
//820068801,
//820071260,
//820073429,
//820076078,
//820077084,
//820077249,
//820078378,
//820078522,
//820078685,
//820081051,
//820081180,
//820082569,
//820088900,
//820090378,
//820090580,
//820091024,
//820092269,
//820093173,
//820100600,
//820102854,
//820102898,
//820108951,
//820109929,
//820110176,
//820114847,
//820115057,
//820117256,
//820118441,
//820119284,
//820119763,
//820119946,
//820121223,
//820122871,
//820128165,
//820128226,
//820133340,
//820137807,
//820138393,
//820138752,
//820140001,
//820143500,
//820147132,
//820148003,
//820150904,
//820152362,
//820154595,
//820155241,
//820155349,
//820158857,
//820159976,
//820161476,
//820162959,
//820163331,
//820167687,
//820174070,
//820175944,
//820177960,
//820181991,
//820184892,
//820189318,
//820189818,
//820194895,
//820196190,
//820198108,
//820198705,
//820199028,
//820199966,
//820201990,
//820202491,
//820203077,
//820205591,
//820205804,
//820216556,
//820217421,
//820218081,
//820218203,
//820219360,
//820220342,
//820220410,
//820220635,
//820220713,
//820221399,
//820222470,
//820225871,
//820226592,
//820227543,
//820227971,
//820229166,
//820229171,
//820233632,
//820236899,
//820237779,
//820238006,
//820240491,
//820244586,
//820247624,
//820247671,
//820250795,
//820251116,
//820251431,
//820255046,
//820261142,
//820262336,
//820263365,
//820266790,
//820267154,
//820268067,
//820269674,
//820269756,
//820273539,
//820274503,
//820275995,
//820276326,
//820277019,
//820277173,
//820280714,
//820282448,
//820285065,
//820288915,
//820291826,
//820291950,
//820292392,
//820292572,
//820293112,
//820294118,
//820299083,
//820300742,
//820304590,
//820306871,
//820307085,
//820311488,
//820314252,
//820316602,
//820316815,
//820317523,
//820320437,
//820321556,
//820323427,
//820325908,
//820329165,
//820332932,
//820332968,
//820333615,
//820334210,
//820334493,
//820334968,
//820336302,
//820336956,
//820337426,
//820342951,
//820343183,
//820344210,
//820347272,
//820347781,
//820349292,
//820349472,
//820350795,
//820351707,
//820352081,
//820352779,
//820353485,
//820357688,
//820357832,
//820360035,
//820361263,
//820362049,
//820362689,
//820362782,
//820364312,
//820366773,
//820367501,
//820369233,
//820370069,
//820374527,
//820374529,
//820377121,
//820385434,
//820390153,
//820393573,
//820394226,
//820399925,
//820401932,
//820402916,
//820404334,
//820405770,
//820405958,
//820406101,
//820406383,
//820407174,
//820408367,
//820408898,
//820410782,
//820411384,
//820411975,
//820413167,
//820416238,
//820417445,
//820417648,
//820419889,
//820421266,
//820421284,
//820423496,
//820426429,
//820431649,
//820432429,
//820438385,
//820439593,
//820439612,
//820440448,
//820442052,
//820442138,
//820443675,
//820443756,
//820443772,
//820444923,
//820445674,
//820447185,
//820448112,
//820448141,
//820448166,
//820449466,
//820449956,
//820451783,
//820457537,
//820462205,
//820462707,
//820463983,
//820464138,
//820465345,
//820465759,
//820466792,
//820466852,
//820470880,
//820475488,
//820478297,
//820479126,
//820482664,
//820485027,
//820489599,
//820498586,
//820498860,
//820500259,
//820506388,
//820507241,
//820508607,
//820510785,
//820515431,
//820518912,
//820519523,
//820520441,
//820522707,
//820523588,
//820527271,
//820527330,
//820527755,
//820529684,
//820530680,
//820531471,
//820533363,
//820534194,
//820534221,
//820534269,
//820537673,
//820539528,
//820543175,
//820546595,
//820546941,
//820547259,
//820548286,
//820549670,
//820550556,
//820552441,
//820552982,
//820556483,
//820557300,
//820557584,
//820558259,
//820560095,
//820560387,
//820562559,
//820567672,
//820570353,
//820570728,
//820571700,
//820572177,
//820572696,
//820573969,
//820575466,
//820576288,
//820580480,
//820581729,
//820582404,
//820585869,
//820586225,
//820587574,
//820590288,
//820591708,
//820591905,
//820592777,
//820593718,
//820593820,
//820594004,
//820594653,
//820597263,
//820598240,
//820599733,
//820601389,
//820603179,
//820605507,
//820606415,
//820611369,
//820613962,
//820617077,
//820617373,
//820617440,
//820617961,
//820618479,
//820619952,
//820621500,
//820622915,
//820624802,
//820627481,
//820627968,
//820629060,
//820630155,
//820630581,
//820631363,
//820632852,
//820633492,
//820635811,
//820635845,
//820636121,
//820636321,
//820637023,
//820639064,
//820639722,
//820640783,
//820642146,
//820648253,
//820652751,
//820652988,
//820660736,
//820661248,
//820662059,
//820662165,
//820662631,
//820665374,
//820665632,
//820666600,
//820668898,
//820671027,
//820671571,
//820672141,
//820673992,
//820676935,
//820680636,
//820682492,
//820682510,
//820685471,
//820687341,
//820688545,
//820691493,
//820692141,
//820692805,
//820697060,
//820697933,
//820698319,
//820699519,
//820699596,
//820701837,
//820702661,
//820704418,
//820704523,
//820705716,
//820707812,
//820708074,
//820712653,
//820714471,
//820714882,
//820715935,
//820716922,
//820718471,
//820718875,
//820720119,
//820725668,
//820726578,
//820727448,
//820729316,
//820730806,
//820730908,
//820731915,
//820735739,
//820738123,
//820738519,
//820742874,
//820744435,
//820744491,
//820746036,
//820746829,
//820749972,
//820750115,
//820750875,
//820751951,
//820753031,
//820754579,
//820754958,
//820758131,
//820758469,
//820763841,
//820768015,
//820768046,
//820769171,
//820770936,
//820777415,
//820778520,
//820780139,
//820784433,
//820784687,
//820785598,
//820785918,
//820789131,
//820789204,
//820789648,
//820792784,
//820797433,
//820797979,
//820798003,
//820800970,
//820800978,
//820804412,
//820804589,
//820806631,
//820806844,
//820807771,
//820807916,
//820811447,
//820814719,
//820815584,
//820815642,
//820815891,
//820816310,
//820818183,
//820819296,
//820821782,
//820824527,
//820825115,
//820826170,
//820827689,
//820833683,
//820835751,
//820837348,
//820837744,
//820837792,
//820837914,
//820841034,
//820841810,
//820845503,
//820846047,
//820846965,
//820850339,
//820851472,
//820853121,
//820858831,
//820860642,
//820863273,
//820863628,
//820864974,
//820869317,
//820869404,
//820869783,
//820871959,
//820873411,
//820876878,
//820877823,
//820878468,
//820879233,
//820880715,
//820884411,
//820884420,
//820885390,
//820885993,
//820886011,
//820889354,
//820889422,
//820895911,
//820897080,
//820898312,
//820900832,
//820901614,
//820903752,
//820904056,
//820906830,
//820908492,
//820910418,
//820912340,
//820915472,
//820915519,
//820917484,
//820919466,
//820920701,
//820920737,
//820923411,
//820926427,
//820927336,
//820927458,
//820929721,
//820930173,
//820931488,
//820932607,
//820933101,
//820933691,
//820933922,
//820935847,
//820936950,
//820939019,
//820944183,
//820944194,
//820944956,
//820946464,
//820947560,
//820947690,
//820948186,
//820950917,
//820951372,
//820951594,
//820953526,
//820954555,
//820956010,
//820957481,
//820958448,
//820962886,
//820965378,
//820965419,
//820966783,
//820968124,
//820969906,
//820970169,
//820971945,
//820971982,
//820975291,
//820977374,
//820977422,
//820981413,
//820981815,
//820982337,
//820985217,
//820987143,
//820988280,
//820988628,
//820988715,
//820989058,
//820991193,
//820993952,
//820995064,
//820996632,
//820996950,
//820997138
//);
//		
//		$empty_user_cnt = array(
//			'api_shop_medal_use' => array(
//				Pp_ShopManager::CONSUME_TYPE_CONTINUE => 0,
//				Pp_ShopManager::CONSUME_TYPE_RECOVER_STAMINA => 0,
//				Pp_ShopManager::CONSUME_TYPE_EXPAND_MONSTER_BOX => 0,
//			),
//			'api_shop_gacha_exec' => array(
//				38 => 0,
//				39 => 0,
//				40 => 0,
//				41 => 0,
//				42 => 0,
//				43 => 0,
//			)
//		);
//		
//		$user_cnt_assoc = array();
//		foreach ($user_id_list as $user_id) {
//			$user_cnt_assoc[$user_id] = $empty_user_cnt;
//		}
//		
//		$arg_key_assoc = array(
//			'api_shop_medal_use' => 'consume_id',
//			'api_shop_gacha_exec' => 'gacha_id',
//		);
//		
//		$db_r =& $this->backend->getDB('r');
//		
//		$sql = "SELECT *"
//             . " FROM t_point_transaction"
//             . " WHERE date_modified >= '2014-08-31 15:00:00'"
//             . " AND date_modified < '2014-09-01 11:30:00'"
//             . " AND point_output_sts = 'OK'"
//             . " AND (action = 'api_shop_medal_use' OR  action = 'api_shop_gacha_exec')"
//             . " AND user_id IN(" . implode(',', $user_id_list) . ")";
//		
//		$adodb_countrecs_old = $admin_m->setAdodbCountrecs(false);
//		$result =& $db_r->query($sql);
//		while ($row = $result->FetchRow()) {
//			$user_id = $row['user_id'];
//			$action = $row['action'];
//			
//			if ($row['point_path'] != '/Payment/Consume/') {
//				error_log('ERROR:user_id=[' . $row['user_id']);
//				continue;
//			}
//				
//			if (strlen($row['game_arg']) > 0) {
//				$game_arg_assoc = json_decode($row['game_arg'], true);
//			} else {
//				$game_arg_assoc = null;
//			}
//			
//			if (empty($game_arg_assoc)) {
//				error_log('ERROR:user_id=[' . $row['user_id']);
//				continue;
//			}
//			
//			if (!isset($arg_key_assoc[$action])) {
//				error_log('ERROR:user_id=[' . $row['user_id']);
//				continue;
//			}
//			
//			$arg_key = $arg_key_assoc[$action]; // 'consume_id' または 'gacha_id'
//			
//			if (!isset($game_arg_assoc[$arg_key])) {
//				error_log('ERROR:user_id=[' . $row['user_id']);
//				continue;
//			}
//			
//			$arg_value = intval($game_arg_assoc[$arg_key]); // consume_id または gacha_id の値
//			
//			if (!isset($user_cnt_assoc[$user_id][$action][$arg_value])) {
//				error_log('ERROR:user_id=[' . $row['user_id']);
//				continue;
//			}
//			
//			$user_cnt_assoc[$user_id][$action][$arg_value] += 1;
//		}
//		
//		$admin_m->setAdodbCountrecs($adodb_countrecs_old);
//		
//		$filename = BASE . '/tmp/point20140902unit' . $this->config->get('unit_id');
//		file_put_contents($filename, serialize($user_cnt_assoc));
//		
//        return null;
//    }
//	
//    protected function performMerge()
//    {
//		$user_cnt_assoc = null;
//		
//		$unit_all = $this->config->get('unit_all');
//		foreach (array_keys($unit_all) as $unit) {
//			$filename = BASE . '/tmp/point20140902unit' . $unit;
//			$file_contents = file_get_contents($filename);
//			$user_cnt_assoc_tmp = unserialize($file_contents);
//			
//			if ($user_cnt_assoc === null) {
//				$user_cnt_assoc = $user_cnt_assoc_tmp;
//			} else {
//				foreach ($user_cnt_assoc_tmp as $user_id => $tmp_assoc) {
//					foreach ($tmp_assoc as $action => $tmp_assoc2) {
//						foreach ($tmp_assoc2 as $arg_value => $cnt) {
//							if ($cnt == 0) {
//								continue;
//							}
//							
//							$user_cnt_assoc[$user_id][$action][$arg_value] += $cnt;
//error_log("DEBUG:[$user_id][$action][$arg_value][" . $user_cnt_assoc[$user_id][$action][$arg_value] . "][" . $cnt. "]");
//						}
//					}
//				}
//			}
//		}
//
//		$filename_w = BASE . '/tmp/point20140902';
//		file_put_contents($filename_w, serialize($user_cnt_assoc));
//		
//        return null;
//    }
//	
//	protected function performFormat()
//	{
//		$shop_m =& $this->backend->getManager('AdminShop');
//		
//		$filename = BASE . '/tmp/point20140902';
//		$file_contents = file_get_contents($filename);
//		$user_cnt_assoc = unserialize($file_contents);
//
//		$filename_csv = BASE . '/tmp/point20140902.csv';
//		$fp = fopen($filename_csv, 'w');
//		
//		$col_info = array(
//			array('api_shop_medal_use', Pp_ShopManager::CONSUME_TYPE_CONTINUE),
//			array('api_shop_medal_use', Pp_ShopManager::CONSUME_TYPE_RECOVER_STAMINA),
//			array('api_shop_medal_use', Pp_ShopManager::CONSUME_TYPE_EXPAND_MONSTER_BOX),
//			array('api_shop_gacha_exec', 38),
//			array('api_shop_gacha_exec', 39),
//			array('api_shop_gacha_exec', 40),
//			array('api_shop_gacha_exec', 41),
//			array('api_shop_gacha_exec', 42),
//			array('api_shop_gacha_exec', 43),
//		);
//		
//		$header_arr = array('user_id');
//		foreach ($col_info as $tmp_arr) {
//			$header_arr[] = $tmp_arr[0] . $tmp_arr[1];
//		}
//		
//		$header = implode(',' , $header_arr) . "\r\n";
//		fwrite($fp, $header);
//		
//		foreach ($user_cnt_assoc as $user_id => $user_cnt) {
//			$line_arr = array($user_id);
//			foreach ($col_info as $tmp_arr) {
//				$line_arr[] = $user_cnt[$tmp_arr[0]][$tmp_arr[1]];
//			}
//		
//			$line = implode(',', $line_arr) . "\r\n";
//			fwrite($fp, $line);
//		}
//		
//		fclose($fp);
//	}
	
}

?>
